substitutions:
  _IMAGE_NAME: ss-comparison-service
  _GCS_CACHE_BUCKET: central-mvn-cache-rckms
steps:
  # load the cache from GCS if it exists
  - name: gcr.io/cloud-builders/gsutil
    dir: /root
    entrypoint: bash
    args:
      - -c
      - |
        (
          gsutil cp gs://${_GCS_CACHE_BUCKET}/${_IMAGE_NAME}-m2-cache-${BRANCH_NAME}.tar.gz /tmp/${_IMAGE_NAME}-m2-cache-${BRANCH_NAME}.tar.gz &&
          tar -xzf /tmp/${_IMAGE_NAME}-m2-cache-${BRANCH_NAME}.tar.gz
        ) || echo 'Cache not found'
    volumes:
      - name: m2
        path: /root/.m2
  - name: gcr.io/cloud-builders/mvn
    id: build
    args:
      [
        "clean",
        "install",
        "jib:build",
        "-DskipTests",
        "-Dimage=us.gcr.io/${PROJECT_ID}/${_IMAGE_NAME}",
        "-Dbranchtag=${BRANCH_NAME}",
        "-Dshatag=${SHORT_SHA}",
      ]
    volumes:
      - name: m2
        path: /root/.m2
  # cache the /root/.m2 folder and upload it to GCS bucket
  - name: gcr.io/cloud-builders/gsutil
    waitFor:
      - build
    dir: /root
    entrypoint: bash
    args:
      - -c
      - |
        tar -czf /tmp/${_IMAGE_NAME}-m2-cache-${BRANCH_NAME}.tar.gz .m2 &&
        gsutil cp /tmp/${_IMAGE_NAME}-m2-cache-${BRANCH_NAME}.tar.gz gs://${_GCS_CACHE_BUCKET}/${_IMAGE_NAME}-m2-cache-${BRANCH_NAME}.tar.gz
    volumes:
      - name: m2
        path: /root/.m2
  - name: "gcr.io/cloud-builders/kubectl"
    id: gke-deploy-image
    waitFor:
      - build
    entrypoint: "bash"
    args:
      - -c
      - |
        gcloud container clusters get-credentials --project="$PROJECT_ID" --region="${_GKE_REGION}" "${_GKE_CLUSTER}" || exit
        kubectl set image deployment/${_GKE_WORKLOAD} ${_GKE_WORKLOAD}=us.gcr.io/hln-rckms/${_GKE_WORKLOAD}:$SHORT_SHA --namespace=${_GKE_NAMESPACE} || exit 0
